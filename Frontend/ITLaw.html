<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="keywords" content="Site keywords here">
    <meta name="description" content="">
    <meta name='copyright' content=''>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Title -->
    <title>프라벤</title>

    <!-- Favicon -->
    <link rel="icon" href="img/favicon.png">
		
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- Nice Select CSS -->
    <link rel="stylesheet" href="css/nice-select.css">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <!-- icofont CSS -->
    <link rel="stylesheet" href="css/icofont.css">
    <!-- Slicknav -->
    <link rel="stylesheet" href="css/slicknav.min.css">
    <!-- Owl Carousel CSS -->
    <link rel="stylesheet" href="css/owl-carousel.css">
    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="css/datepicker.css">
    <!-- Animate CSS -->
    <link rel="stylesheet" href="css/animate.min.css">
    <!-- Magnific Popup CSS -->
    <link rel="stylesheet" href="css/magnific-popup.css">
    
    <!-- Medipro CSS -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/responsive.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #response { display: none; } /* 초기 상태에서는 숨김 */
    </style>
</head>
<body>
    <!-- Header Area -->
    <header class="header" >
        <div class="header-inner">
            <div class="container">
                <div class="inner">
                    <div class="row">
                        <div class="col-lg-3 col-md-3 col-12">
                            <!-- Start Logo -->
                            <div class="logo">
                                <a href="index.html"><img src="img/logo.png" alt="#"></a>
                            </div>
                            <!-- End Logo -->
                            <!-- Mobile Nav -->
                            <div class="mobile-nav"></div>
                            <!-- End Mobile Nav -->
                        </div>
                        <div class="col-lg-7 col-md-9 col-12">
                            <!-- Main Menu -->
                            <div class="main-menu">
                                <nav class="navigation">
                                    <ul class="nav menu">
                                        <li><a href="#">프라벤 소식지<i class="icofont-rounded-down"></i></a>
                                            <ul class="dropdown">
                                                <li><a href="index.html">공지사항</a></li>
                                                <li><a href="index.html">활동사진</a></li>
                                            </ul>
                                        </li>
                                        <li><a href="#">회사소개 </a></li>
                                        <li class="active"><a href="#">서비스<i class="icofont-rounded-down"></i></a>
                                            <ul class="dropdown">
                                                <li><a href="https://play.google.com/store/apps/details?id=com.hsj.powerclicker&hl=ko">파워 클리커</a></li>
                                                <li><a href="ITLaw.html">잇(IT)법</a></li>
                                            </ul>
                                        </li>
                                        <li><a href="#">소통 창구 <i class="icofont-rounded-down"></i></a>
                                            <ul class="dropdown">
                                                <li><a href="index.html">문의사항</a></li>
                                                <li><a href="index.html">자유게시판</a></li>
                                            </ul>
                                        </li>
                                        <li><a href="#">입사지원 <i class="icofont-rounded-down"></i></a>
                                            <ul class="dropdown">
                                                <li><a href="index.html">채용공고</a></li>
                                                <li><a href="index.html">합격자 발표</a></li>
                                            </ul>
                                        </li>
                                        <li><a href="index.html">ESG</a></li>
                                    </ul>
                                </nav>
                            </div>
                            <!--/ End Main Menu -->
                        </div>
                        <div class="col-lg-2 col-12">
                            <div class="get-quote">
                                <a href="index.html" class="btn">로그인</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--/ End Header Inner -->
    </header>
    <!-- End Header Area -->

    <h1>법률 AI 서비스</h1>
    <form id="queryForm">
        <label for="prompt">상담 내용을 적어주세요:</label><br>
        <textarea id="prompt" name="prompt" rows="4" cols="50"></textarea><br><br>
        <button type="submit">상담요청</button>
    </form>
    <div id="response">
        <h2>응답:</h2>
        <strong>관련 법령:</strong><br>
        <div id="relatedLaws"></div><br>
        <strong>변호사 AI 조언:</strong><br>
        <div id="aiAdvice"></div>
    </div>

    <script>
        $("#queryForm").on("submit", function(event) {
            event.preventDefault();

            const prompt = $("#prompt").val();
            let originalLanguage = ""; // 입력 언어를 저장할 변수

            // 응답 박스를 보여줌
            $("#response").show();
            $("#relatedLaws").html(""); // 초기화
            $("#aiAdvice").html(""); // 초기화

            // 1. Prompt를 영어로 번역
            fetch("http://ekaf.kro.kr:25901/translate", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    q: prompt,
                    source: "auto",
                    target: "en",
                    format: "text"
                })
            })
            .then(response => response.json())
            .then(promptTranslation => {
                const translatedPrompt = promptTranslation.translatedText;

                // 감지된 언어를 JSON 응답에서 가져오기
                originalLanguage = promptTranslation.detectedLanguage?.language || "en"; // 기본값: "en"

                // 디버깅 정보 출력
                console.log("Translation API Response:", promptTranslation);
                console.log("Original Language Detected:", originalLanguage);
                console.log("Translated Prompt:", translatedPrompt);

                // 2. Retrieve 단계
                fetch("http://ekaf.kro.kr:25901/retrieve", {  // 프록시 서버로 요청
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ query: prompt })
                })
                .then(response => response.json())
                .then(retrieveData => {
                    const temp_rt = retrieveData.map(item => item.text).join(" ");

                    // 관련 법령 즉시 출력
                    $("#relatedLaws").html(temp_rt);

                    // 디버깅 정보 출력
                    console.log("Retrieve Data:", retrieveData);
                    console.log("Temp Retrieve Text:", temp_rt);

                    // 3. Translate Retrieve 단계
                    fetch("http://ekaf.kro.kr:25901/translate", {  // 프록시 서버로 요청
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            q: temp_rt,
                            source: "auto",
                            target: "en",
                            format: "text"
                        })
                    })
                    .then(response => response.json())
                    .then(translatedRetrieveData => {
                        const translatedText = translatedRetrieveData.translatedText;

                        // 디버깅 정보 출력
                        console.log("Translated Retrieve Text:", translatedText);

                        // 4. LLM 단계
                        const messages = [
                            {
                                role: "system",
                                content: `You are a Police Officer. Answer the question with provided documents. The question is: ${translatedPrompt}`
                            },
                            {
                                role: "user",
                                content: `Provided document: ${translatedText}`
                            }
                        ];

                        fetch("http://ekaf.kro.kr:25901/chat", {  // 프록시 서버로 요청
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                model: "llama3.2:1b",
                                messages: messages,
                                stream: false
                            })
                        })
                        .then(response => response.json())
                        .then(llmResponse => {
                            const assistantResponse = llmResponse.choices[0].message.content;

                            // 디버깅 정보 출력
                            console.log("LLM Response:", llmResponse);
                            console.log("Assistant Response:", assistantResponse);

                            // 5. 번역 결과를 처음 입력한 언어로 다시 번역
                            fetch("http://ekaf.kro.kr:25901/translate", {  // 프록시 서버로 요청
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    q: assistantResponse,
                                    source: "en",  // 영어에서
                                    target: originalLanguage,  // 처음 입력 언어로 번역
                                    format: "text"
                                })
                            })
                            .then(response => response.json())
                            .then(finalTranslation => {
                                const finalText = finalTranslation.translatedText;

                                // 디버깅 정보 출력
                                console.log("Final Translated Text:", finalText);

                                // 변호사 AI 조언 출력
                                $("#aiAdvice").html(finalText);
                            });
                        });
                    });
                });
            })
            .catch(error => {
                console.error("Error:", error.message);
                $("#response").html(`<strong>Error:</strong> ${error.message}`);
            });
        });
    </script>
</body>
</html>
